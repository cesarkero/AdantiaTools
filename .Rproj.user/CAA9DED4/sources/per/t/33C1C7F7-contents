source("C:/GitHub/AdantiaTools/funciones.R")

#set parameters
PhotoFolder <- "C:\\GitHub\\AdantiaTools\\01_FotosTool\\Sources" #photo folder
ShpToJoin <- "Z:\\Proxectos\\448_Seguementos_PPEE_zonas_4b_5\\5_GIS\\SHP_PPEE\\PPEE.shp" #shp to join data
exiftags <- c("FileName", "CreateDate", "GPSPosition")
Tec1 <- "cac"
Tec2 <- "lbn"

FotosTool <- function (PhotoFolder, ShpToJoin, exiftags, Tec1, Tec2){
    files <- list.files(PhotoFolder, pattern="*.jpg|.JPG", full.names=T) # Read just .jpg files with exifr
    p.files <- read_exif(files, tags=exiftags) # Select fields of interest



    # newfile name from "AAAA:MM:DD HH:mm:ss" to "AAAAMMDD_HHmmss_001.jpg"
    a <- str_replace(str_replace_all(p.files$CreateDate,":","")," ","_")
    counter <- CreateCounter(nrow(p.files),3) #create counter
    filename <- paste0(a,"_",Tec1,"_",Tec2,"_",counter,".jpg") # create filename
    p.files <- mutate(p.files, newfilename = filename) #add new column with filename
    file.rename(files,paste(p.folder,"\\",p.files$newfilename,sep="")) # Rename files with the newfilename


    #separar x e y en columnas y unificar los decimales 5
    #PASAR DESDE AQUÍ A FUNCION INDICANDO QUE SE PIDA GPSPOSITION Y NEWFILENAME U OTRA ID

    coords <- strsplit(p.files$GPSPosition, " ") #splits unique text of coords into y,x list

    XYdf <- data.frame(newfilenames = numeric(), # creates empty dataframe
                       x = numeric(),
                       y = numeric())

    length(p.files$GPSPosition)
    for (i in 1:length(p.files$GPSPosition)){
        x <- coords[[i]][2]
        numX <- sub('\\..*','',x) #mantiene todo lo que hay delante de un punto
        decX <- substr(sub('...\\.*','',x),1,5) #mantiene todo lo que hay detras de un punto
        corX <- paste0(numX,'.',decX)
        corX
        y <- coords[[i]][1]
        numY <- sub('\\..*','',y) #mantiene todo lo que hay delante de un punto
        decY <- substr(sub('...\\.*','',y),1,5) #mantiene todo lo que hay detras de un punto
        corY <- paste0(numY,'.',decY)
        XYdf[i,] <- c(p.files$newfilename[i], corX, corY) #add values to df
    }

    # Add collums from exif data:
    p.files <-
        p.files %>%
        mutate(X_coord = X_coord_list)%>%
        mutate(Y_coord = Y_coord_list)%>%
        mutate(Ano = str_sub(p.files$CreateDate,1,4))%>%
        mutate(Mes = str_sub(p.files$CreateDate,6,7))%>%
        mutate(Dia = str_sub(p.files$CreateDate,9,10))%>%
        mutate(Hora = str_sub(p.files$CreateDate,12,13))%>%
        mutate(Min = str_sub(p.files$CreateDate,15,16))%>%
        mutate(Seg = str_sub(p.files$CreateDate,18,19))
    # addd a new collum with the previous newfilepath to the table photos_sel
    p.files <- mutate(p.files, newfilepath = paste0(p.folder,"\\",newfilename))

    #modify colnames and save file
    file_name <- paste(p.folder,"\\","fotos_vinculada.csv",sep="")
    colnames(p.files) <- c("SourceFile","FileName","CreateDate",
                           "GPSPosition","newfilename","X_coord",
                           "Y_coord","Ano","Mes","Dia","Hora","Min",
                           "Seg","filepath")
    write.csv2(p.files, file = file_name,row.names=FALSE, na="")
}

# Read just .jpg files with exifr
files <- list.files(p.folder, pattern="*.jpg|.JPG", full.names=T)
# Select fields of interest
p.files <- read_exif(files, tags=c("FileName", "CreateDate", "GPSPosition"))

# CREATE NEW VARIABLES: newfilename
# Creates a chain from field 'CreateDate'
# The aim is to change "AAAA:MM:DD HH:mm:ss" to "AAAAMMDD_HHmmss_001.jpg"
a <- str_replace(str_replace_all(p.files$CreateDate,":","")," ","_")

# Create a counter to add to photo file --> 001 ...999 type. Length of the number of files.
counter <- c(1:nrow(p.files))
counter <- str_replace_all(str_pad(sapply(counter,toString),3,"left")," ","0")
b <- paste0(a,"_",tec1,"_",tec2,"_",counter,".jpg")

# add a new collum with the previous newfilename to the table photos_sel
p.files <- mutate(p.files,newfilename = b)

# Rename files with the newfilename (in the photo folder and not into the wd)
file.rename(files,paste(p.folder,"\\",p.files$newfilename,sep=""))

# CREATE A TABLE WITH THE COLUMNS OF INTEREST
#create list of X_coord (ojo seleccion distinta de caracteres en hemisferio norte por el - en coord x)
coords <- strsplit(p.files$GPSPosition, " ")
X_coord_list <- c()
Y_coord_list <- c()
for (i in coords){
        X_coord_list <-  c(X_coord_list, str_sub(i[2],9,start=1))
}
for (i in coords){
        Y_coord_list <-  c(Y_coord_list, str_sub(i[1],8,start=1))
}

# Add collums from exif data:
p.files <-
    p.files %>%
    mutate(X_coord = X_coord_list)%>%
    mutate(Y_coord = Y_coord_list)%>%
    mutate(Ano = str_sub(p.files$CreateDate,1,4))%>%
    mutate(Mes = str_sub(p.files$CreateDate,6,7))%>%
    mutate(Dia = str_sub(p.files$CreateDate,9,10))%>%
    mutate(Hora = str_sub(p.files$CreateDate,12,13))%>%
    mutate(Min = str_sub(p.files$CreateDate,15,16))%>%
    mutate(Seg = str_sub(p.files$CreateDate,18,19))
# addd a new collum with the previous newfilepath to the table photos_sel
p.files <- mutate(p.files, newfilepath = paste0(p.folder,"\\",newfilename))

#modify colnames and save file
file_name <- paste(p.folder,"\\","fotos_vinculada.csv",sep="")
colnames(p.files) <- c("SourceFile","FileName","CreateDate",
                       "GPSPosition","newfilename","X_coord",
                       "Y_coord","Ano","Mes","Dia","Hora","Min",
                       "Seg","filepath")
write.csv2(p.files, file = file_name,row.names=FALSE, na="")

